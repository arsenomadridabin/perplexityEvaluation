{% extends 'evaluation_app/base.html' %}
{% load evaluation_filters %}

{% block title %}Evaluation - Polymer Evaluation Tool{% endblock %}

{% block content %}
{% csrf_token %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="mb-0"><i class="fas fa-check-circle"></i> Property Classification</h4>
                <div>
                    <span class="badge bg-primary">{{ matched_pairs.count }} Pairs</span>
                    <span class="badge bg-success">{{ properties|length }} Properties</span>
                </div>
            </div>
            <div class="card-body">
                <p class="text-muted">
                    <i class="fas fa-info-circle"></i> 
                    Classify each property as TP, FP, TN, or FN according to your evaluation criteria.
                </p>
            </div>
        </div>
    </div>
</div>

{% if matched_pairs %}
    {% for pair in matched_pairs %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-link"></i> 
                    Pair {{ forloop.counter }}: {{ pair.ground_truth.polymer_system }} ↔ {{ pair.predicted.polymer_system }}
                    <span class="badge bg-secondary">{{ pair.ground_truth.force_field }}</span>
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th style="width: 25%;">Property</th>
                                <th style="width: 25%;">Ground Truth</th>
                                <th style="width: 25%;">Prediction</th>
                                <th style="width: 25%;">Classification</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for property in properties %}
                                <tr>
                                    <td>
                                        <strong>{{ property }}</strong>
                                    </td>
                                    <td>
                                        <code class="gt-value">
                                            {% if property == 'polymer_system' %}
                                                {{ pair.ground_truth.polymer_system }}
                                            {% elif property == 'force_field' %}
                                                {{ pair.ground_truth.force_field }}
                                            {% elif property == 'Density (g/cm³)' %}
                                                {{ pair.ground_truth.density_value }}
                                            {% elif property == 'Glass Transition Temperature (K)' %}
                                                {{ pair.ground_truth.glass_transition_temp_value }}
                                            {% elif property == 'Radius of Gyration (nm)' %}
                                                {{ pair.ground_truth.radius_of_gyration_value }}
                                            {% elif property == 'Young\'s Modulus (GPa)' %}
                                                {{ pair.ground_truth.youngs_modulus_value }}
                                            {% elif property == 'Diffusion Coefficient (m²/s)' %}
                                                {{ pair.ground_truth.diffusion_coefficient_value }}
                                            {% elif property == 'Viscosity (Pa s)' %}
                                                {{ pair.ground_truth.viscosity_value }}
                                            {% else %}
                                                NA
                                            {% endif %}
                                        </code>
                                    </td>
                                    <td>
                                        <code class="pred-value">
                                            {% if property == 'polymer_system' %}
                                                {{ pair.predicted.polymer_system }}
                                            {% elif property == 'force_field' %}
                                                {{ pair.predicted.force_field }}
                                            {% elif property == 'Density (g/cm³)' %}
                                                {{ pair.predicted.density_value }}
                                            {% elif property == 'Glass Transition Temperature (K)' %}
                                                {{ pair.predicted.glass_transition_temp_value }}
                                            {% elif property == 'Radius of Gyration (nm)' %}
                                                {{ pair.predicted.radius_of_gyration_value }}
                                            {% elif property == 'Young\'s Modulus (GPa)' %}
                                                {{ pair.predicted.youngs_modulus_value }}
                                            {% elif property == 'Diffusion Coefficient (m²/s)' %}
                                                {{ pair.predicted.diffusion_coefficient_value }}
                                            {% elif property == 'Viscosity (Pa s)' %}
                                                {{ pair.predicted.viscosity_value }}
                                            {% else %}
                                                NA
                                            {% endif %}
                                        </code>
                                    </td>
                                    <td>
                                        <div class="classification-buttons" data-pair-id="{{ pair.id }}" data-property="{{ property }}">
                                            <button class="btn btn-sm btn-tp classification-btn" data-classification="TP">
                                                TP
                                            </button>
                                            <button class="btn btn-sm btn-fp classification-btn" data-classification="FP">
                                                FP
                                            </button>
                                            <button class="btn btn-sm btn-tn classification-btn" data-classification="TN">
                                                TN
                                            </button>
                                            <button class="btn btn-sm btn-fn classification-btn" data-classification="FN">
                                                FN
                                            </button>
                                            {% with pair_classifications=classifications|get_item:pair.id %}
                                                {% if pair_classifications|get_item:property %}
                                                    <span class="badge ms-2 badge-{{ pair_classifications|get_item:property|lower }}">
                                                        {{ pair_classifications|get_item:property }}
                                                    </span>
                                                {% endif %}
                                            {% endwith %}
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    {% endfor %}

    <div class="row mt-4">
        <div class="col-12 text-center">
            <a href="{% url 'statistics' %}" class="btn btn-primary btn-lg me-3">
                <i class="fas fa-chart-bar"></i> View Statistics
            </a>
            <a href="{% url 'export_results' %}" class="btn btn-success btn-lg">
                <i class="fas fa-download"></i> Export Results
            </a>
        </div>
    </div>
{% else %}
    <div class="card">
        <div class="card-body text-center py-5">
            <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
            <h4>No Matched Pairs Found</h4>
            <p class="text-muted">You need to create matched pairs before you can evaluate them.</p>
            <a href="{% url 'matching' %}" class="btn btn-primary btn-lg">
                <i class="fas fa-link"></i> Go to Matching
            </a>
        </div>
    </div>
{% endif %}
{% endblock %}

{% block extra_css %}
<style>
.gt-value {
    background-color: #d4edda;
    border: 1px solid #c3e6cb;
    color: #155724;
}

.pred-value {
    background-color: #d1ecf1;
    border: 1px solid #bee5eb;
    color: #0c5460;
}

.classification-buttons {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
    align-items: center;
}

.classification-btn {
    min-width: 40px;
    font-weight: bold;
    transition: all 0.2s;
}

.classification-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.classification-btn.selected {
    box-shadow: inset 0 0 0 2px white;
}

.btn-tp {
    background-color: var(--success-color);
    color: white;
}

.btn-fp {
    background-color: var(--danger-color);
    color: white;
}

.btn-tn {
    background-color: #6c757d;
    color: white;
}

.btn-fn {
    background-color: var(--warning-color);
    color: white;
}

.badge-tp { background-color: var(--success-color); }
.badge-fp { background-color: var(--danger-color); }
.badge-tn { background-color: #6c757d; }
.badge-fn { background-color: var(--warning-color); }

code {
    padding: 4px 8px;
    border-radius: 4px;
    font-family: monospace;
    font-size: 0.9em;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Classification button functionality
document.querySelectorAll('.classification-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const container = this.closest('.classification-buttons');
        const pairId = container.dataset.pairId;
        const property = container.dataset.property;
        const classification = this.dataset.classification;
        
        // Remove selected class from all buttons in this container
        container.querySelectorAll('.classification-btn').forEach(b => {
            b.classList.remove('selected');
        });
        
        // Add selected class to clicked button
        this.classList.add('selected');
        
        // Save classification
        saveClassification(pairId, property, classification);
    });
});

function saveClassification(pairId, property, classification) {
    fetch('{% url "save_classification" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            pair_id: pairId,
            property_name: property,
            classification: classification
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the badge
            const container = document.querySelector(`[data-pair-id="${pairId}"][data-property="${property}"]`);
            let badge = container.querySelector('.badge');
            
            if (!badge) {
                badge = document.createElement('span');
                badge.className = `badge ms-2 badge-${classification.toLowerCase()}`;
                container.appendChild(badge);
            } else {
                badge.className = `badge ms-2 badge-${classification.toLowerCase()}`;
            }
            
            badge.textContent = classification;
            
            // Show success message
            showAlert(data.message, 'success');
        } else {
            showAlert(data.error, 'danger');
        }
    })
    .catch(error => {
        showAlert('Error saving classification: ' + error, 'danger');
    });
}

// Initialize selected states based on existing classifications
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.classification-buttons').forEach(container => {
        const badge = container.querySelector('.badge');
        if (badge) {
            const classification = badge.textContent;
            const btn = container.querySelector(`[data-classification="${classification}"]`);
            if (btn) {
                btn.classList.add('selected');
            }
        }
    });
});
</script>
{% endblock %} 